name: Temp File Sharing

on:
    workflow_dispatch:
        inputs:
            dir:
                description: The base directory to share
                required: false
                default: ".store"

jobs:
    serve:
        runs-on: ubuntu-latest
        timeout-minutes: 120
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Setup PNPM
              uses: pnpm/action-setup@v2.2.2
              with:
                  version: latest
                  run_install: true

            - name: Build
              run: pnpm build

            - name: Install Cloudflared
              run: |
                  echo 'deb http://pkg.cloudflare.com/ focal main' | sudo tee /etc/apt/sources.list.d/cloudflare-main.list
                  curl -C - https://pkg.cloudflare.com/pubkey.gpg | sudo apt-key add -
                  sudo apt-get update
                  sudo apt-get install cloudflared

            - name: Start Server (Anonymous)
              if: "${{ secrets.token == '' }}"
              env:
                  DIR: ${{ inputs.dir }}
              run: |
                  pnpm run start &
                  sudo cloudflared tunnel --url http://localhost:3000

            - name: Start Server (Authenticated)
              if: "${{ secrets.token != '' }}"
              env:
                  DIR: ${{ inputs.dir }}
              run: |
                  pnpm run start &
                  sudo cloudflared service install ${{ secrets.token }}
